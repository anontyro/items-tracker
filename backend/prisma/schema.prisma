generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id            String          @id @default(uuid())
  name          String
  type          String          @default("board-game")
  // Optional BoardGameGeek ID for cross-site canonical mapping
  bggId         String?         
  bggCanonicalName String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  priceHistory  PriceHistory[]
  tracking      ProductTracking[]
  wishlistItems WishlistItem[]
  sources       ProductSource[]
  images        ProductImage[]

  @@index([name])
  @@index([type])
  @@index([bggId])
}

model ProductSource {
  id             String         @id @default(uuid())
  productId      String
  sourceName     String         // "Board Game Co UK"
  sourceUrl      String         @unique
  sku            String?
  additionalData Json?          // Unstructured data
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  product        Product        @relation(fields: [productId], references: [id])
  priceHistory   PriceHistory[]
  images         ProductImage[]

  @@index([productId])
  @@index([sourceName])
}

model PriceHistory {
  id             String    @id @default(uuid())
  productId      String
  sourceId       String
  price          Decimal   @db.Decimal(10, 2)
  availability   Boolean?  // true, false, null for unknown
  rrp            Decimal?  @db.Decimal(10, 2)
  scrapedAt      DateTime  @default(now())

  // Scraping metadata
  scrapeSuccess  Boolean   @default(true)
  scrapeJobId    String?
  responseTimeMs Int?

  product        Product       @relation(fields: [productId], references: [id])
  source         ProductSource @relation(fields: [sourceId], references: [id])

  @@index([productId, scrapedAt])
  @@index([sourceId, scrapedAt])
  @@index([scrapedAt])
  @@unique([productId, sourceId, scrapedAt])
}

model ProductTracking {
  id               String   @id @default(uuid())
  productId        String
  userId           String?  // Null for MVP (localStorage), populated later

  // Tracking conditions
  trackType        String   @default("general") // general, price_drop, back_in_stock
  priceThreshold   Decimal? @db.Decimal(10, 2)
  priceDropPercent Decimal? @db.Decimal(5, 2)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  product          Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([userId])
}

model WishlistItem {
  id        String   @id @default(uuid())
  productId String
  userId    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([userId])
}

model BggGame {
  id            String   @id @default(uuid())
  bggId         String   @unique
  primaryName   String
  name          String?
  yearPublished Int?
  rank          Int?
  bayesAverage  Float?
  average       Float?
  usersRated    Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastSeenAt    DateTime?

  @@index([primaryName])
  @@index([name])
}

enum ImageStatus {
  ACTIVE
  MISSING
  DELETED
}

model ProductImage {
  id            String       @id @default(uuid())
  productId     String?
  bggId         String?
  sourceId      String?
  remoteImageUrl String
  localPath     String?
  status        ImageStatus  @default(ACTIVE)
  lastCheckedAt DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  product Product?       @relation(fields: [productId], references: [id])
  source  ProductSource? @relation(fields: [sourceId], references: [id])

  @@index([bggId])
  @@index([productId])
  @@index([bggId, status, updatedAt])
  @@index([productId, status, updatedAt])
}
